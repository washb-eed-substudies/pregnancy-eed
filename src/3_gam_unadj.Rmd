---
title: "Hypothesis 1"
output: html_document
date: "2024-03-27"
---


```{r}

library(boxr)
library(dplyr)
library(ggplot2)
library(ggcorrplot)
library(gridExtra)

library(devtools)
#install_github("ben-arnold/washb")

library(here)
#source("0-config.R")

library(tidyverse)
library(haven)
library(washb)
library(tmle)
library(foreign)
library(data.table)
library(devtools)
library(kableExtra)
library(here)
library(boxr)

directory <-  "/Users/xianshengyan/pregnancy-eed/"
setwd(directory)

```

```{r}

# Construct the path to the RDS file directly within the project folder
data_path <- "bangladesh-cleaned-master-data.RDS"

# Read the data from the RDS file
d <- readRDS(data_path)

```


```{r}
#Hypothesis 3 Variables

Xvars <- c("ln_preg_estri")
Yvars <- c("ln_mpo1", "ln_mpo2", "ln_mpo3", "ln_aat1", "ln_aat2", "ln_aat3", "ln_neo1", "ln_neo2", "ln_neo3", "ln_reg2", "ln_L_conc_t1", "ln_L_conc_t2", "ln_L_conc_t3", "ln_M_conc_t1", "ln_M_conc_t2", "ln_M_conc_t3")
```



```{r}
H3_models <- NULL
for(i in Xvars){
  for(j in Yvars){
    res_unadj <- fit_RE_gam(d=d, X=i, Y=j,  W=NULL)
    res <- data.frame(X=i, Y=j, fit=I(list(res_unadj$fit)), dat=I(list(res_unadj$dat)))
    H3_models <- bind_rows(H3_models, res)
  }
}
```

```{r}
#Get primary contrasts
H3_res <- NULL
for(i in 1:nrow(H3_models)){
  res <- data.frame(X=H3_models$X[i], Y=H3_models$Y[i])
  preds <- predict_gam_diff(fit=H3_models$fit[i][[1]], d=H3_models$dat[i][[1]], quantile_diff=c(0.25,0.75), Xvar=res$X, Yvar=res$Y)
  H3_res <-  bind_rows(H3_res , preds$res)
}

```

```{r}
#Make list of plots
H3_plot_list <- NULL
H3_plot_data <- NULL
for(i in 1:nrow(H3_models)){
  res <- data.frame(X=H3_models$X[i], Y=H3_models$Y[i])
  simul_plot <- gam_simul_CI(H3_models$fit[i][[1]], H3_models$dat[i][[1]], xlab=res$X, ylab=res$Y, title="")
  H3_plot_list[[i]] <-  simul_plot$p
  H3_plot_data <-  rbind(H3_plot_data, data.frame(Xvar=res$X, Yvar=res$Y, adj=0, simul_plot$pred))
}


#Save models
saveRDS(H3_models, "models/H3_models.RDS")

#Save results
saveRDS(H3_res, "results/unadjusted/H3_res.RDS")


#Save plots
#saveRDS(H3_plot_list, here("figure-objects/H3_unadj_splines.RDS"))

#Save plot data
saveRDS(H3_plot_data,"figure-data/H3_unadj_spline_data.RDS")
```


```{r}
results <- readRDS("results/unadjusted/H3_res.RDS")
write_csv(results,"results/unadjusted/H3_res.csv")
```



[1] "ln_preg_cort"
[1] "ln_mpo"
d$ln_M_conc_t1
```

